{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/yammir/Documents/Yammir/DOCUMENTOSSSS%20ANTES%20DE%20LA%20ACRTUALIZACION/WEB%C2%B4S/d-irma/src/app/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { createServerClient } from \"@supabase/ssr\";\nimport { cookies, headers } from \"next/headers\"; // IMPORTAR HEADERS\nimport { redirect } from \"next/navigation\";\n\nasync function getSupabase() {\n  const cookieStore = await cookies();\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options),\n            );\n          } catch {}\n        },\n      },\n    },\n  );\n}\n\nexport async function createOrder(prevState: any, formData: FormData) {\n  const supabase = await getSupabase();\n  const headerStore = await headers();\n\n  // 1. Datos del Cliente y Dispositivo\n  const ip = headerStore.get(\"x-forwarded-for\") || \"IP Desconocida\";\n  const userAgent = headerStore.get(\"user-agent\") || \"Dispositivo Desconocido\";\n\n  const name = formData.get(\"name\") as string;\n  const office = formData.get(\"office\") as string;\n  const phone = formData.get(\"phone\") as string;\n  const opCode = formData.get(\"operation_code\") as string;\n  const method = formData.get(\"payment_method\") as string;\n\n  // 2. SEGURIDAD DE PRECIOS (CRÍTICO)\n  const rawItems = formData.get(\"items\") as string;\n  const clientItems = JSON.parse(rawItems); // Items que envía el cliente\n\n  // Extraemos los IDs de los productos que pide el cliente\n  const productIds = clientItems.map((item: any) => item.product.id);\n\n  // Consultamos a la BD los precios REALES de esos IDs\n  const { data: dbProducts, error: prodError } = await supabase\n    .from(\"products\")\n    .select(\"id, price, name\")\n    .in(\"id\", productIds);\n\n  if (prodError || !dbProducts) {\n    return { success: false, message: \"Error al verificar precios.\" };\n  }\n\n  // Recalculamos el total nosotros mismos\n  let calculatedTotal = 0;\n\n  // Reconstruimos los items con el precio real de la BD\n  const verifiedItems = clientItems.map((item: any) => {\n    const realProduct = dbProducts.find((p) => p.id === item.product.id);\n\n    if (!realProduct) {\n      // Si alguien intenta pedir un producto que no existe, ignoramos o lanzamos error\n      throw new Error(`Producto inválido: ${item.product.id}`);\n    }\n\n    // Usamos el precio de la BD, no el del JSON\n    const realPrice = realProduct.price;\n    calculatedTotal += realPrice * item.qty;\n\n    return {\n      ...item,\n      product: {\n        ...item.product,\n        price: realPrice, // Forzamos el precio real\n        name: realProduct.name,\n      },\n      price: realPrice, // Guardamos el precio unitario histórico\n    };\n  });\n\n  // 3. SEGURIDAD: VERIFICAR LISTA NEGRA\n  const { data: customer } = await supabase\n    .from(\"customers\")\n    .select(\"is_blacklisted\")\n    .eq(\"phone\", phone)\n    .single();\n\n  if (customer?.is_blacklisted) {\n    return {\n      success: false,\n      message: \"Número con restricciones. Contacte soporte.\",\n    };\n  }\n\n  // 4. ACTUALIZAR O CREAR CLIENTE (Lógica inteligente que te di antes)\n  if (customer) {\n    await supabase\n      .from(\"customers\")\n      .update({ office: office })\n      .eq(\"phone\", phone);\n  } else {\n    await supabase\n      .from(\"customers\")\n      .insert({ phone: phone, full_name: name, office: office });\n  }\n\n  // 5. ESTADO DEL PAGO\n  let paymentStatus = \"unpaid\";\n  if (method === \"yape\") paymentStatus = \"verifying\";\n  else if (method === \"monthly\") paymentStatus = \"on_account\";\n\n  // 6. GUARDAR PEDIDO (Usando calculatedTotal y verifiedItems)\n  const { data, error } = await supabase\n    .from(\"orders\")\n    .insert({\n      customer_name: name,\n      customer_phone: phone,\n      customer_office: office,\n      items: verifiedItems, // <--- ITEMS VERIFICADOS\n      total_amount: calculatedTotal, // <--- TOTAL CALCULADO POR EL SERVIDOR\n      payment_method: method,\n      payment_status: paymentStatus,\n      operation_code: opCode || null,\n      is_monthly_account: method === \"monthly\",\n      status: \"pending\",\n      metadata: {\n        ip: ip,\n        device: userAgent,\n        timestamp: new Date().toISOString(),\n      },\n    })\n    .select()\n    .single();\n\n  if (error) {\n    console.error(\"Error:\", error);\n    return { success: false, message: \"Error al procesar. Intenta de nuevo.\" };\n  }\n\n  redirect(`/pedido/${data.id}`);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 140, "column": 0}, "map": {"version":3,"sources":["file:///Users/yammir/Documents/Yammir/DOCUMENTOSSSS%20ANTES%20DE%20LA%20ACRTUALIZACION/WEB%C2%B4S/d-irma/.next-internal/server/app/%28client%29/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {createOrder as '6061af35b7effceb1b03519a0f5b0411506813e76e'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}