{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/yammir/Documents/Yammir/DOCUMENTOSSSS%20ANTES%20DE%20LA%20ACRTUALIZACION/WEB%C2%B4S/d-irma/src/app/actions.ts"],"sourcesContent":["'use server'\n\nimport { createServerClient } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\nimport { redirect } from 'next/navigation'\n\n// Crear cliente seguro en servidor\nasync function getSupabase() {\n  const cookieStore = await cookies()\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() { return cookieStore.getAll() },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // Contexto de Server Component\n          }\n        },\n      },\n    }\n  )\n}\n\nexport async function createOrder(prevState: any, formData: FormData) {\n  const supabase = await getSupabase()\n  \n  // 1. EXTRAER DATOS DEL FORMULARIO\n  const rawItems = formData.get('items') as string\n  const items = JSON.parse(rawItems)\n  const total = parseFloat(formData.get('total') as string)\n  const method = formData.get('payment_method') as string // 'yape' | 'monthly'\n  \n  const name = formData.get('name') as string\n  const office = formData.get('office') as string\n  const phone = formData.get('phone') as string\n  const opCode = formData.get('operation_code') as string\n  \n  // 2. VALIDACIÓN DE SEGURIDAD (LISTA NEGRA)\n  // Buscamos si el cliente ya existe por su teléfono\n  const { data: customer } = await supabase\n    .from('customers')\n    .select('is_blacklisted')\n    .eq('phone', phone)\n    .single()\n\n  // SI ESTÁ EN LISTA NEGRA: Bloqueamos todo tipo de pedido\n  if (customer?.is_blacklisted) {\n    return {\n      success: false,\n      message: 'Usuario con restricciones administrativas. Por favor contacte soporte.'\n    }\n  }\n\n  // 3. REGISTRO/ACTUALIZACIÓN DE CLIENTE (CRÍTICO PARA EL REPORTE)\n  // Usamos 'upsert': Si no existe, lo crea. Si existe, actualiza nombre y oficina.\n  // Esto asegura que tu base de datos de clientes siempre tenga los datos frescos.\n  const { error: customerError } = await supabase\n    .from('customers')\n    .upsert({ \n      phone: phone, // Clave única\n      full_name: name, \n      office: office\n      // Nota: No tocamos 'is_blacklisted', se mantiene su valor actual o false por defecto\n    }, { onConflict: 'phone' })\n\n  if (customerError) {\n    console.error('Error actualizando cliente:', customerError)\n    // No detenemos el pedido, pero lo logueamos\n  }\n\n  // 4. DEFINIR ESTADO DEL PAGO\n  let paymentStatus = 'unpaid'\n  \n  if (method === 'yape') {\n    paymentStatus = 'verifying' // Requiere que revises el código de operación\n  } else if (method === 'monthly') {\n    paymentStatus = 'on_account' // <--- ESTADO CLAVE PARA TU REPORTE DE DEUDA\n  }\n\n  // 5. INSERTAR EL PEDIDO EN SUPABASE\n  const { data, error } = await supabase.from('orders').insert({\n    customer_name: name,\n    customer_phone: phone,\n    customer_office: office,\n    items: items,\n    total_amount: total,\n    payment_method: method,\n    payment_status: paymentStatus,\n    operation_code: opCode || null,\n    is_monthly_account: method === 'monthly', // Flag útil para filtros rápidos\n    status: 'pending' // Estado de la cocina (Pendiente, Cocinando, Entregado)\n  }).select().single()\n\n  if (error) {\n    console.error('Error insertando pedido:', error)\n    return { success: false, message: 'Ocurrió un error al guardar el pedido. Inténtalo de nuevo.' }\n  }\n\n  // 6. REDIRECCIÓN A PÁGINA DE ÉXITO\n  redirect(`/pedido/${data.id}`)\n}"],"names":[],"mappings":";;;;;AAEA;AAAA;AACA;AACA;AAAA;;;;;;AAEA,mCAAmC;AACnC,eAAe;IACb,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,OAAO,IAAA,+LAAkB,sUAGvB;QACE,SAAS;YACP;gBAAW,OAAO,YAAY,MAAM;YAAG;YACvC,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,+BAA+B;gBACjC;YACF;QACF;IACF;AAEJ;AAEO,eAAe,YAAY,SAAc,EAAE,QAAkB;IAClE,MAAM,WAAW,MAAM;IAEvB,kCAAkC;IAClC,MAAM,WAAW,SAAS,GAAG,CAAC;IAC9B,MAAM,QAAQ,KAAK,KAAK,CAAC;IACzB,MAAM,QAAQ,WAAW,SAAS,GAAG,CAAC;IACtC,MAAM,SAAS,SAAS,GAAG,CAAC,iBAA4B,qBAAqB;;IAE7E,MAAM,OAAO,SAAS,GAAG,CAAC;IAC1B,MAAM,SAAS,SAAS,GAAG,CAAC;IAC5B,MAAM,QAAQ,SAAS,GAAG,CAAC;IAC3B,MAAM,SAAS,SAAS,GAAG,CAAC;IAE5B,2CAA2C;IAC3C,mDAAmD;IACnD,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,aACL,MAAM,CAAC,kBACP,EAAE,CAAC,SAAS,OACZ,MAAM;IAET,yDAAyD;IACzD,IAAI,UAAU,gBAAgB;QAC5B,OAAO;YACL,SAAS;YACT,SAAS;QACX;IACF;IAEA,iEAAiE;IACjE,iFAAiF;IACjF,iFAAiF;IACjF,MAAM,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,aACL,MAAM,CAAC;QACN,OAAO;QACP,WAAW;QACX,QAAQ;IAEV,GAAG;QAAE,YAAY;IAAQ;IAE3B,IAAI,eAAe;QACjB,QAAQ,KAAK,CAAC,+BAA+B;IAC7C,4CAA4C;IAC9C;IAEA,6BAA6B;IAC7B,IAAI,gBAAgB;IAEpB,IAAI,WAAW,QAAQ;QACrB,gBAAgB,aAAY,8CAA8C;IAC5E,OAAO,IAAI,WAAW,WAAW;QAC/B,gBAAgB,cAAa,6CAA6C;IAC5E;IAEA,oCAAoC;IACpC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,UAAU,MAAM,CAAC;QAC3D,eAAe;QACf,gBAAgB;QAChB,iBAAiB;QACjB,OAAO;QACP,cAAc;QACd,gBAAgB;QAChB,gBAAgB;QAChB,gBAAgB,UAAU;QAC1B,oBAAoB,WAAW;QAC/B,QAAQ,UAAU,wDAAwD;IAC5E,GAAG,MAAM,GAAG,MAAM;IAElB,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO;YAAE,SAAS;YAAO,SAAS;QAA6D;IACjG;IAEA,mCAAmC;IACnC,IAAA,iMAAQ,EAAC,CAAC,QAAQ,EAAE,KAAK,EAAE,EAAE;AAC/B;;;IA7EsB;;AAAA,+OAAA"}},
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///Users/yammir/Documents/Yammir/DOCUMENTOSSSS%20ANTES%20DE%20LA%20ACRTUALIZACION/WEB%C2%B4S/d-irma/.next-internal/server/app/%28client%29/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {createOrder as '60120e5d59dc505793a8b7963832cc855373bf880f'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}